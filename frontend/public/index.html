<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restaurant Guide Finder</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Eigene CSS -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Banner -->
  <div id="app-banner" class="text-center p-3 bg-light shadow-sm">
    <h1>Restaurant Guide Finder</h1>
  </div>

  <!-- Buttons + Datum/Uhrzeit -->
  <div class="container d-flex justify-content-between align-items-center my-2 flex-wrap">
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary">Anmelden</button>
      <button class="btn btn-outline-success">Registrieren</button>
    </div>
    <div id="date-time" class="text-end text-muted small"></div>
  </div>
  <div>
    <div id="map" style="height: 400px; width: 100%;"></div>
  </div>

  <!-- Restaurantliste (React root) -->
  <div class="container" id="root"></div>

  <!-- Footer -->
  <footer class="text-center mt-4 mb-3">
    <p>© 2025 Restaurant Guide Finder · <a href="#">Impressum</a></p>
  </footer>

  <!-- React Code -->
  <script type="text/babel">


    function getSterneIcons(bewertung) {
      const zahl = parseFloat(bewertung.replace(",", "."));
      const ganze = Math.floor(zahl);
      const halber = zahl % 1 >= 0.5;
      const sterne = [];

      for (let i = 0; i < ganze; i++) {
        sterne.push(<span key={"s" + i}>⭐</span>);
      }
      if (halber) {
        sterne.push(<span key="halb">✩</span>);
      }

      return sterne;
    }

    function RestaurantItem({ restaurant }) {
      const [showMap, setShowMap] = React.useState(false);
      const mapRef = React.useRef(null);
      const mapInstanceRef = React.useRef(null);

      React.useEffect(() => {
        if (showMap && mapRef.current && !mapInstanceRef.current) {
          const { google } = window;
          mapInstanceRef.current = new google.maps.Map(mapRef.current, {
            center: { lat: restaurant.lat, lng: restaurant.lng },
            zoom: 15,
          });

          new google.maps.Marker({
            position: { lat: restaurant.lat, lng: restaurant.lng },
            map: mapInstanceRef.current,
            title: restaurant.name,
          });
        }
      }, [showMap, restaurant.lat, restaurant.lng, restaurant.name]);

      return (
        <li className="list-group-item d-flex flex-column">
          <div className="d-flex justify-content-between align-items-center">
            <div>
              <strong>{restaurant.name}</strong><br />
              <small>{restaurant.kontakt}</small><br />
              <small>Bewertung: {getSterneIcons(restaurant.bewertung)} ({restaurant.bewertung})</small>
            </div>
            <button className="btn btn-sm btn-outline-dark" onClick={() => setShowMap(!showMap)}>
              {showMap ? "Schließen" : "Karte"}
            </button>
          </div>
          {showMap && (
            <div className="mt-3">
              <div ref={mapRef} style={{ height: "300px", width: "100%" }} className="border rounded">
              </div>
            </div>
          )
          }
        </li >
      );
    }

// THEO TEST

function RestaurantList() {
  const [restaurants, setRestaurants] = React.useState([]);
  const [loading, setLoading] = React.useState(false);

  const plzRef = React.useRef();
  const queryRef = React.useRef();
  const radiusRef = React.useRef();

  const fetchRestaurants = async () => {
    const city = plzRef.current?.value || "";
    const cuisine = queryRef.current?.value || "";
    const radius = radiusRef.current?.value || "";

    setLoading(true);
    try {
      const response = await fetch(
        `http://localhost:5000/api/places/search?city=${city}&cuisine=${cuisine}&radius=${radius}`
      );
      const data = await response.json();
      setRestaurants(data);
    } catch (err) {
      console.error("Fehler beim Abrufen:", err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      {/* Suchformular */}
      <div className="container my-4">
        <div className="card p-4 shadow">
          <div className="row g-3">
            <div className="col-md-4">
              <input ref={queryRef} type="text" className="form-control" placeholder="Gericht oder Land suchen..." />
            </div>
            <div className="col-md-2">
              <input ref={plzRef} type="text" className="form-control" placeholder="Postleitzahl" />
            </div>
            <div className="col-md-2">
              <input ref={radiusRef} type="number" className="form-control" placeholder="Radius (km)" />
            </div>
            <div className="col-md-2">
              <select className="form-select">
                <option disabled selected>Bewertung</option>
                <option value="5">5 Sterne</option>
                <option value="4">4 Sterne</option>
                <option value="3">3 Sterne</option>
                <option value="2">2 Sterne</option>
                <option value="1">1 Stern</option>
              </select>
            </div>
            <div className="col-md-2">
              <button onClick={fetchRestaurants} className="btn btn-primary w-100">Suchen</button>
            </div>
          </div>
        </div>
      </div>

      {/* Ergebnisliste */}
      <div className="container">
        <div className="card p-4 shadow">
          <h4 className="mb-3">Gefundene Restaurants</h4>
          {loading ? (
            <p>Lade Restaurants...</p>
          ) : restaurants.length === 0 ? (
            <p>Keine Restaurants gefunden.</p>
          ) : (
            <ul className="list-group">
              {restaurants.map((res) => (
                <RestaurantItem key={res.id} restaurant={res} />
              ))}
            </ul>
          )}
        </div>
      </div>
    </>
  );
}


    ReactDOM.createRoot(document.getElementById("root")).render(<RestaurantList />);

    // Datum/Uhrzeit mit MEZ
    const now = new Date();
    const formatter = new Intl.DateTimeFormat("de-DE", {
      dateStyle: "full",
      timeStyle: "short",
      timeZone: "Europe/Berlin"
    });
    document.getElementById("date-time").textContent = formatter.format(now) + " (MEZ)";
  
  </script>

  <!-- Google Maps API -->
   <script 
   async
   defer 
   src="https://maps.googleapis.com/maps/api/js?key=DEINAPIKEY&loading=async&callback=initMap">
    </script>
</body>

</html>